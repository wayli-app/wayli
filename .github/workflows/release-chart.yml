name: Release Helm Charts

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

# Required permissions for GitHub Pages and releases
permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    # Only run if Release workflow succeeded (or if manually triggered)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for chart changes
        id: chart_changes
        run: |
          # Check if charts directory was modified in the last 2 commits
          if git diff --name-only HEAD~2 HEAD | grep -q '^charts/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üì¶ Chart files were modified"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No chart files were modified, skipping release"
          fi

      - name: Configure Git
        if: steps.chart_changes.outputs.changed == 'true'
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        if: steps.chart_changes.outputs.changed == 'true'
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add Helm repositories
        if: steps.chart_changes.outputs.changed == 'true'
        run: |
          helm repo add supabase-helm https://wayli-app.github.io/supabase-helm
          helm repo update

      - name: Update chart dependencies
        if: steps.chart_changes.outputs.changed == 'true'
        run: |
          helm dependency update charts/wayli

      - name: Run chart-releaser
        if: steps.chart_changes.outputs.changed == 'true'
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
          config: .github/cr.yaml
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_SKIP_EXISTING: "true"
